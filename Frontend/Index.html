
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Datenabfrage Webanwendung</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

    <!--
mein-projekt/
│
├── frontend/
│   ├── index.html
│   ├── style.css
│   └── script.js
│
├── backend/
│   ├── app.py             ← Flask-Server/API
│   ├── db.py              ← DB-Verbindung
│   └── models/            ← (optional) Datenmodelle
│
└── README.md
-->

  <button class="button" onclick="openStep1()">Abfrage starten</button>

  <div class="modal" id="step1">
    <h2>Anlagen auswählen</h2>
    <div class="checkbox-group" id="anlagenList">
  <label><input type="checkbox" value="Aasanurme" /> Aasanurme</label><br />
  <label><input type="checkbox" value="Augusta" /> Augusta</label><br />
  <label><input type="checkbox" value="Babimost 2" /> Babimost 2</label><br />
  <label><input type="checkbox" value="Besingrand" /> Besingrand</label><br />
  <label><input type="checkbox" value="Calarasi" /> Calarasi</label>
</div>
    <div class="modal-footer">
      <button class="button" onclick="goToStep2()">Weiter</button>
    </div>
  </div>

  <div class="modal" id="step2">
    <h2>Details auswählen</h2>
    <div id="nachrichtAnlagen"></div>
    <div class="checkbox-group" id="detailsList">
  <label><input type="checkbox" value="Battery_Voltage" /> Chip_Temp</label><br />
  <label><input type="checkbox" value="Set_Angle" /> Motor_Current_Max</label><br />
  <label><input type="checkbox" value="Error_Flags" /> Error_Flags</label>
</div>


    <div class="date-select">
      <div>
        <label for="startDay">Startdatum:</label><br />
        <select id="startDay"></select>
        <select id="startMonth"></select>
        <select id="startYear"></select>
      </div>
      <div>
        <label for="endDay">Enddatum:</label><br />
        <select id="endDay"></select>
        <select id="endMonth"></select>
        <select id="endYear"></select>
      </div>
    </div>

    <div class="time-select">
      <div>
        <label for="startTime">Startzeit:</label><br />
        <select id="startTime"></select>
      </div>
      <div>
        <label for="endTime">Endzeit:</label><br />
        <select id="endTime"></select>
      </div>
    </div>

    <div class="modal-footer">
      <button class="button" onclick="startAuswertung()">Weiter</button>
    </div>
  </div>

  <div id="results"></div>

  <script>
  let selectedAnlagen = [];
  let selectedDetails = [];

  function openStep1() {
    document.getElementById("step1").classList.add("active");
    document.getElementById("results").innerHTML = "";
    clearStep2Selections();
  }

  function clearStep2Selections() {
    document.getElementById("nachrichtAnlagen").textContent = "";
    const detailsCheckboxes = document.querySelectorAll("#detailsList input[type='checkbox']");
    detailsCheckboxes.forEach(cb => cb.checked = false);
  }

  function goToStep2() {
    const checkboxes = document.querySelectorAll("#anlagenList input[type='checkbox']:checked");
    selectedAnlagen = Array.from(checkboxes).map((cb) => cb.value);
    if (selectedAnlagen.length === 0) {
      alert("Bitte wählen Sie mindestens eine Anlage aus.");
      return;
    }
    document.getElementById("step1").classList.remove("active");
    document.getElementById("step2").classList.add("active");
    document.getElementById("nachrichtAnlagen").textContent = "Wert nach Datenabfrage...";
  }
  
  async function startAuswertung() {
    const checkboxes = document.querySelectorAll("#detailsList input[type='checkbox']:checked");
    selectedDetails = Array.from(checkboxes).map((cb) => cb.value);
    if (selectedDetails.length === 0) {
      alert("Bitte wählen Sie mindestens ein Detail aus.");
      return;
    }

    // Datum und Zeit auslesen
    const startDay = document.getElementById("startDay").value;
    const startMonth = document.getElementById("startMonth").value;
    const startYear = document.getElementById("startYear").value;

    const endDay = document.getElementById("endDay").value;
    const endMonth = document.getElementById("endMonth").value;
    const endYear = document.getElementById("endYear").value;

    const startTime = document.getElementById("startTime").value;
    const endTime = document.getElementById("endTime").value;

    const startDatum = `${startYear}-${startMonth.padStart(2, "0")}-${startDay.padStart(2, "0")}`;
    const endDatum = `${endYear}-${endMonth.padStart(2, "0")}-${endDay.padStart(2, "0")}`;

    document.getElementById("step2").classList.remove("active");

    const resultsDiv = document.getElementById("results");
    resultsDiv.innerHTML = "<h3>Auswertungsergebnisse</h3>";

    // Daten vom Backend abrufen
    try {
      const res = await fetch("http://localhost:5000/api/data?" + new URLSearchParams({
        "anlagen[]": selectedAnlagen,
        "details[]": selectedDetails,
        "start": `${startDatum} ${startTime}`,
        "end": `${endDatum} ${endTime}`
      }));

      const data = await res.json();

      selectedAnlagen.forEach((anlage) => {
        resultsDiv.innerHTML += `<h4>${anlage}</h4>`;
        resultsDiv.innerHTML += `<p><strong>Zeitraum:</strong> ${startDatum} ${startTime} bis ${endDatum} ${endTime}</p>`;

        const relevantData = data.filter(d => d.anlage === anlage);
        if (relevantData.length === 0) {
          resultsDiv.innerHTML += `<p><em>Keine Daten gefunden.</em></p>`;
        } else {
          relevantData.forEach((d) => {
            resultsDiv.innerHTML += `<p><strong>${d.detail}:</strong> ${d.wert} (${d.timestamp})</p>`;
          });
        }
      });
    } catch (error) {
      resultsDiv.innerHTML = "<p style='color:red;'>Fehler beim Abrufen der Daten. Stelle sicher, dass das Backend läuft.</p>";
      console.error("Fehler bei API-Aufruf:", error);
    }
  }

  // Dropdowns mit Uhrzeiten füllen (bis 24:00)
  function populateTimeDropdowns() {
    const times = [];
    for (let h = 0; h <= 24; h++) {
      times.push((h < 10 ? "0" + h : h) + ":00");
    }

    const startSelect = document.getElementById("startTime");
    const endSelect = document.getElementById("endTime");

    times.forEach((time) => {
      const optionStart = document.createElement("option");
      optionStart.value = time;
      optionStart.textContent = time;
      startSelect.appendChild(optionStart);

      const optionEnd = document.createElement("option");
      optionEnd.value = time;
      optionEnd.textContent = time;
      endSelect.appendChild(optionEnd);
    });
  }

  // Dropdowns mit Tagen füllen
  function populateDayDropdowns() {
    const days = [];
    for (let d = 1; d <= 31; d++) {
      days.push(d.toString());
    }
    ["startDay", "endDay"].forEach((id) => {
      const select = document.getElementById(id);
      select.innerHTML = "";
      days.forEach((day) => {
        const option = document.createElement("option");
        option.value = day;
        option.textContent = day;
        select.appendChild(option);
      });
    });
  }

  // Dropdowns mit Monaten füllen
  function populateMonthDropdowns() {
    const months = [
      "01", "02", "03", "04", "05", "06",
      "07", "08", "09", "10", "11", "12"
    ];
    ["startMonth", "endMonth"].forEach((id) => {
      const select = document.getElementById(id);
      select.innerHTML = "";
      months.forEach((month) => {
        const option = document.createElement("option");
        option.value = month;
        option.textContent = month;
        select.appendChild(option);
      });
    });
  }

  // Dropdowns mit Jahren füllen (z.B. 2020 bis 2030)
  function populateYearDropdowns() {
    const currentYear = new Date().getFullYear();
    const years = [];
    for (let y = currentYear - 5; y <= currentYear + 5; y++) {
      years.push(y.toString());
    }
    ["startYear", "endYear"].forEach((id) => {
      const select = document.getElementById(id);
      select.innerHTML = "";
      years.forEach((year) => {
        const option = document.createElement("option");
        option.value = year;
        option.textContent = year;
        select.appendChild(option);
      });
    });
  }

  populateTimeDropdowns();
  populateDayDropdowns();
  populateMonthDropdowns();
  populateYearDropdowns();
</script>


</body>
</html>

